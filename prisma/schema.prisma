// 1. Setting up the environment
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ====================================================================
// 2. ENUMS
// ====================================================================

// 2.1 User Roles
enum Role {
  ADMIN             // System Admin / Support Staff
  LECTURER          // General Lecturer
  PROGRAM_CHAIR     // Program Chair (1st Approval)
  VICE_DEAN         // Vice Dean (2nd Approval)
  USER              // Default role for new users
}

// 2.2 User Types
enum UserType {
  ACADEMIC // Academic Staff (Lecturers) -> Has teaching load
  SUPPORT  // Support Staff -> System/Document management
}

// 2.3 Approval Status
enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  DRAFT
}

// ====================================================================
// 3. MODELS
// ====================================================================

// [NEW] Curriculum Model (Master Curriculum)
// This model acts as a "Master" to group specific Programs (by year) and Users together.
// Example: "Doctor of Pharmacy Program"
model Curriculum {
  id        Int      @id @default(autoincrement())
  name      String   // Curriculum Name
  
  // Curriculum Chair (Head)
  chairId   String?  @unique
  chair     User?    @relation("CurriculumChair", fields: [chairId], references: [id])

  // Related sub-programs (legacy programs by year)
  programs  Program[] 

  // Staff members belonging to this curriculum
  staffs    User[]    @relation("CurriculumStaff")
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("curriculum_master") // Map to "curriculum_master" in DB to avoid confusion
}

// 3.1 User Model (Updated)
model User {
  id               String    @id @default(cuid())
  email            String?   @unique
  name             String?
  emailVerified    DateTime?
  image            String?
  
  // --- Personal Info ---
  title            String?
  firstName        String?
  lastName         String?
  academicRank     String?
  workStatus       String?
  
  // --- Legacy Fields (Kept for reference) ---
  department       String? // Subject Group (e.g., Clinical Pharmacy)
  curriculum       String? // Curriculum Name (Text)
  adminTitle       String? // Admin Position

  // --- System Data ---
  role             Role      @default(USER)
  userType         UserType  @default(ACADEMIC)
  
  // [NEW] Relation to the new Curriculum table
  // 1. Which curriculum does this user belong to?
  curriculumId     Int?
  curriculumRef    Curriculum? @relation("CurriculumStaff", fields: [curriculumId], references: [id])
  
  // 2. Is this user the Chair of a Curriculum?
  managedCurriculum Curriculum? @relation("CurriculumChair")

  // --- Legacy Relations ---
  managedPrograms  Program[]            @relation("ProgramChair")
  teachingAssignments TeachingAssignment[]
  responsibleSubjects Subject[]         @relation("SubjectResponsible")
  
  // --- Approval Rights ---
  chairApprovals   TeachingAssignment[] @relation("ChairApprovals")
  deanApprovals    TeachingAssignment[] @relation("DeanApprovals")

  // --- NextAuth Relations ---
  accounts         Account[]
  sessions         Session[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("user")
}

// NextAuth Account
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  ext_expires_in    Int?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("account")
}

// NextAuth Session
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

// Verification Token
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtoken")
}

// 3.2 Program Model (Specific by Year)
model Program {
  id             Int      @id @default(autoincrement())
  name_th        String   // Program Name (TH)
  degree_level   String   // Degree Level
  year           Int      // Year (B.E.)
  
  programChairId String?
  programChair   User?    @relation("ProgramChair", fields: [programChairId], references: [id])
  
  // [NEW] Linked to the Master Curriculum
  curriculumId   Int?
  curriculumRef  Curriculum? @relation(fields: [curriculumId], references: [id])

  subjects       Subject[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("program")
}

// 3.3 Subject Model
model Subject {
  id                Int      @id @default(autoincrement())
  code              String
  name_th           String
  name_en           String?
  credit            String
  
  instructor        String?  @db.Text
  program_full_name String?
  
  programId         Int
  program           Program  @relation(fields: [programId], references: [id])
  
  responsibleUserId String?
  responsibleUser   User?    @relation("SubjectResponsible", fields: [responsibleUserId], references: [id])

  teachingAssignments TeachingAssignment[]

  @@unique([code, programId])
  @@map("subject")
}

// 3.4 Teaching Assignment (Workload)
model TeachingAssignment {
  id               Int      @id @default(autoincrement())
  
  academicYear     Int
  semester         Int
  section          String?
  
  // --- Teaching Hours ---
  lectureHours     Float    @default(0.0)
  labHours         Float    @default(0.0)
  examHours        Float    @default(0)

  // =================================================================
  // 4-STEP APPROVAL FLOW
  // =================================================================

  // STEP 1: Lecturer Verification
  lecturerStatus   ApprovalStatus @default(PENDING)
  lecturerFeedback String?        @db.Text // Feedback message for correction
  lecturerActionAt DateTime?

  // STEP 2: Responsible Subject User Review
  responsibleStatus   ApprovalStatus @default(PENDING)
  responsibleActionAt DateTime?

  // STEP 3: Program Chair Approval
  headApprovalStatus ApprovalStatus @default(PENDING)
  headApprovedAt     DateTime?
  headApproverId     String?
  headApprover       User?          @relation("ChairApprovals", fields: [headApproverId], references: [id])

  // STEP 4: Vice Dean Approval
  deanApprovalStatus ApprovalStatus @default(PENDING)
  deanApprovedAt     DateTime?
  deanApproverId     String?
  deanApprover       User?          @relation("DeanApprovals", fields: [deanApproverId], references: [id])

  // --- Relations ---
  lecturerId       String
  lecturer         User           @relation(fields: [lecturerId], references: [id], onDelete: Cascade)
  subjectId        Int
  subject          Subject        @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([lecturerId, academicYear, semester])
  @@map("teachingassignment")
}